<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herramienta Profesional de C√°lculo de Hornos v6.9</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: #333; 
            padding-bottom: 70px; /* Espacio para el footer flotante */
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; color: white; margin: 20px 0; }
        .progress-bar { background: rgba(255,255,255,0.2); border-radius: 25px; height: 50px; margin: 20px 0; position: relative; overflow: hidden; }
        .progress-fill { background: linear-gradient(90deg, #4CAF50, #45a049); height: 100%; border-radius: 25px; transition: width 0.5s ease; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; }
        .step-card { background: white; border-radius: 15px; padding: 30px; margin: 20px 0; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: none; animation: slideIn 0.5s ease; }
        .step-card.active { display: block; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .step-title { color: #4CAF50; font-size: 24px; margin-bottom: 20px; display: flex; align-items: center; }
        .step-number { background: #4CAF50; color: white; min-width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-weight: bold; }
        .input-group { margin: 20px 0; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; align-items: end; }
        .input-field { display: flex; flex-direction: column; }
        label { font-weight: bold; margin-bottom: 5px; color: #555; }
        label small { font-weight: normal; color: #777; display: block; margin-top: 3px; }
        input, select { padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; transition: border-color 0.3s; width: 100%; }
        input:focus, select:focus { outline: none; border-color: #4CAF50; }
        .calculation-display { background: #f0f8ff; border: 2px solid #4CAF50; border-radius: 10px; padding: 20px; margin: 15px 0; }
        .result-highlight { background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #4CAF50; }
        .objetivo-highlight { background: #e3f2fd; color: #0b5e9d; font-weight: bold; padding: 10px; border-radius: 8px; border-left: 4px solid #0b5e9d; }
        .buttons { display: flex; justify-content: space-between; align-items: center; margin-top: 30px; gap: 15px; flex-wrap: wrap; }
        .button-group { display: flex; gap: 10px; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; transition: all 0.3s; font-weight: bold; }
        .btn-primary { background: #4CAF50; color: white; }
        .btn-primary:hover { background: #45a049; transform: translateY(-2px); }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .formula-display { background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin: 15px 0; font-family: 'Courier New', monospace; }
        .final-report { background: white; color: #333; padding: 30px; border-radius: 15px; margin: 20px 0; border: 2px solid #4CAF50; }
        .report-section { margin-bottom: 25px; }
        .report-section h3 { color: #764ba2; margin-top: 0; border-bottom: 2px solid #764ba2; padding-bottom: 5px; margin-bottom: 15px;}
        .report-section ul { list-style-position: inside; padding-left: 5px; }
        .report-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .report-table td { padding: 8px; border: 1px solid #ddd; font-size: 14px; }
        .report-table td:first-child { font-weight: bold; background-color: #f9f9f9; width: 50%; }
        .report-footer { margin-top: 30px; padding-top: 15px; border-top: 1px solid #ccc; text-align: center; font-size: 12px; color: #777; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin: 15px 0; color: #856404; }
        .toggle-container { display: flex; align-items: center; gap: 10px; margin: 20px 0; }
        #aletas-params-div { display: none; }
        .page-footer { 
            position: sticky;
            bottom: 0;
            width: 100%;
            z-index: 1000;
            background-color: rgba(45, 52, 54, 0.65);
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
            padding: 10px 20px;
            color: rgba(255, 255, 255, 0.9);
            text-align: center;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }
        .page-footer a { color: white; text-decoration: none; font-weight: bold; transition: text-decoration 0.3s; }
        .page-footer a:hover { text-decoration: underline; }
        .page-footer svg { width: 20px; height: 20px; vertical-align: middle; margin-right: 8px; fill: currentColor; }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üîß Herramienta Profesional de C√°lculo de Hornos v6.9</h1>
            <p>Dise√±o paso a paso para sistemas de combusti√≥n de biomasa</p>
        </header>
        <div class="progress-bar">
            <div class="progress-fill" id="progressBar">Paso 1 de 7</div>
        </div>

        <main>
            <div class="step-card active" id="step1">
                <div class="step-title"><div class="step-number">1</div>REQUERIMIENTOS T√âRMICOS Y DE BIOMASA</div>
                <div class="input-group">
                    <div class="input-field"><label for="aireCFM">Aire de Proceso (CFM)</label><input type="number" id="aireCFM" value="700"></div>
                    <div class="input-field"><label for="tempAmbiente">Temperatura Ambiente (¬∞C)</label><input type="number" id="tempAmbiente" value="15"></div>
                    <div class="input-field"><label for="tempSalida">Temperatura de Salida (¬∞C)</label><input type="number" id="tempSalida" value="60"></div>
                </div>
                 <div class="input-group">
                    <div class="input-field"><label for="biomassType">Tipo de Biomasa</label><select id="biomassType"><option value="18000">Cisco de Caf√© (18,000 kJ/kg)</option><option value="17500">Cascarilla de Caf√© (17,500 kJ/kg)</option><option value="15000">Cascarilla de Arroz (15,000 kJ/kg)</option><option value="19200">Bagazo de Ca√±a (19,200 kJ/kg)</option><option value="20500">Residuos de Palma (20,500 kJ/kg)</option></select></div>
                    <div class="input-field"><label for="humedadBiomasa">Humedad Biomasa (%)</label><input type="number" id="humedadBiomasa" value="12"></div>
                    <div class="input-field"><label for="eficienciaHorno">Eficiencia del Horno (%)</label><input type="number" id="eficienciaHorno" value="85"></div>
                 </div>
                 <div class="input-group">
                    <div class="input-field"><label for="horasTrabajo">Horas de Trabajo</label><input type="number" id="horasTrabajo" value="32"></div>
                    <div class="input-field"><button class="btn btn-primary" onclick="calcularPaso1()">Calcular Requerimientos</button></div>
                 </div>
                <div id="resultados1" class="calculation-display" style="display:none;"></div>
                <div class="buttons">
                    <button class="btn btn-secondary" disabled>‚Üê Anterior</button>
                    <button class="btn btn-primary" id="siguiente1" onclick="siguientePaso(2)" disabled>Siguiente ‚Üí</button>
                </div>
            </div>

            <div class="step-card" id="step2">
                <div class="step-title"><div class="step-number">2</div>BALANCE DE BIOMASA GENERADA VS REQUERIDA</div>
                <div class="input-group">
                    <div class="input-field"><label for="cafeCapacidad">Entrada de Caf√© H√∫medo (kg)</label><input type="number" id="cafeCapacidad" value="262.5"></div>
                    <div class="input-field"><label for="porcentajeCisco">% Cisco del CPS Final</label><input type="number" id="porcentajeCisco" value="15" max="100"></div>
                     <div class="input-field"><label for="volumenMaquina">Volumen M√°quina (m¬≥)</label><input type="number" id="volumenMaquina" step="0.1" value="15"></div>
                </div>
                <div id="resultados2" class="calculation-display" style="display:none;"></div>
                <div class="buttons">
                    <button class="btn btn-secondary" onclick="siguientePaso(1)">‚Üê Anterior</button>
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="calcularPaso2()">1. Calcular Balance</button>
                        <button class="btn btn-primary" id="siguiente2" onclick="siguientePaso(3)" disabled>2. Siguiente ‚Üí</button>
                    </div>
                </div>
            </div>

            <div class="step-card" id="step3">
                <div class="step-title"><div class="step-number">3</div>AIRE DE COMBUSTI√ìN (VENTILADOR SECUNDARIO)</div>
                <div id="resultados3" class="calculation-display" style="display:none;"></div>
                <div class="buttons">
                    <button class="btn btn-secondary" onclick="siguientePaso(2)">‚Üê Anterior</button>
                    <button class="btn btn-primary" onclick="siguientePaso(4)">Continuar ‚Üí</button>
                </div>
            </div>

            <div class="step-card" id="step4">
                <div class="step-title"><div class="step-number">4</div>TRANSFERENCIA DE CALOR Y √ÅREA REQUERIDA</div>
                <div id="objetivoCalor" class="calculation-display" style="display:none;"></div>
                <div class="input-group">
                    <div class="input-field"><label for="coeficienteH">Coeficiente h (W/m¬≤K)</label><input type="number" id="coeficienteH" step="1" value="180"></div>
                    <div class="input-field"><label for="emissividad">Emisividad (Œµ)</label><input type="number" id="emissividad" step="0.01" value="0.8"></div>
                    <div class="input-field"><label for="tempSuperficie">Temp. Superficie (¬∞C)</label><input type="number" id="tempSuperficie" value="600"></div>
                </div>
                <div class="input-group">
                    <div class="input-field"><label for="areaComun">√Årea de Transferencia (m¬≤) - ITERAR</label><input type="number" id="areaComun" step="0.1" value="1.0"></div>
                    <div class="input-field"><button class="btn btn-primary" onclick="calcularTransferencia()">Calcular Transferencia</button></div>
                    <div class="input-field"><button class="btn btn-secondary" onclick="iterarArea()">Auto-Iterar √Årea</button></div>
                </div>
                <div id="resultados4" class="calculation-display" style="display:none;"></div>
                <div class="buttons">
                    <button class="btn btn-secondary" onclick="siguientePaso(3)">‚Üê Anterior</button>
                    <button class="btn btn-primary" id="siguiente4" onclick="siguientePaso(5)" disabled>Continuar ‚Üí</button>
                </div>
            </div>
            
            <div class="step-card" id="step5">
                <div class="step-title"><div class="step-number">5</div>DISE√ëO √ìPTIMO DE ALETAS (OPCIONAL)</div>
                <div class="toggle-container">
                    <label for="usarAletas"><strong>Activar c√°lculo de aletas para aumentar el √°rea de transferencia</strong></label>
                    <input type="checkbox" id="usarAletas" onchange="toggleAletas()" style="width: auto; height: 20px;">
                </div>
                <div id="aletas-params-div">
                    <div class="formula-display"><strong>F√≥rmula Longitud M√≠nima Efectiva:</strong> L_min = 2.65 √ó ‚àö(K√óAc / (h√óP))</div>
                    <div class="input-group">
                        <div class="input-field"><label for="aletaK">Conductividad T√©rmica (K) (W/mK)<small>Ej: Acero al Carbono ‚âà 50</small></label><input type="number" id="aletaK" value="50"></div>
                        <div class="input-field"><label for="aletaAc">√Årea Transversal (Ac) (mm¬≤)<small>Ej: platina de 50x3mm = 150mm¬≤</small></label><input type="number" id="aletaAc" value="150"></div>
                    </div>
                     <div class="input-group">
                        <div class="input-field"><label for="aletaH">Coeficiente de Transferencia (h) (W/m¬≤K)<small>Aire forzado ‚âà 100-200</small></label><input type="number" id="aletaH" value="120"></div>
                        <div class="input-field">
                            <label for="aletaP">Per√≠metro (P) (mm)<small>Ej: platina de 50x3mm, P=2*(50+3)=106</small></label>
                            <input type="number" id="aletaP" value="106">
                        </div>
                    </div>
                     <div class="input-group">
                        <div class="input-field"><button class="btn btn-primary" onclick="calcularDisenoAletas()">Calcular Longitud M√≠nima</button></div>
                    </div>
                </div>
                <div id="resultados5" class="calculation-display" style="display:none;"></div>
                <div class="buttons">
                    <button class="btn btn-secondary" onclick="siguientePaso(4)">‚Üê Anterior</button>
                    <button class="btn btn-primary" id="siguiente5" onclick="siguientePaso(6)">Continuar con Dise√±o Geom√©trico ‚Üí</button>
                </div>
            </div>

            <div class="step-card" id="step6">
                <div class="step-title"><div class="step-number">6</div>DISE√ëO GEOM√âTRICO Y VALIDACI√ìN FINAL</div>
                <div class="input-group">
                    <div class="input-field"><h4>üî• Cilindro Principal</h4><label for="radioPrincipal">Radio (m)</label><input type="number" id="radioPrincipal" step="0.01" value="0.15"><label for="alturaPrincipal">Altura (m)</label><input type="number" id="alturaPrincipal" step="0.01" value="1.0"></div>
                    <div class="input-field"><h4>üå™Ô∏è C. Cicl√≥nico (Opcional)</h4><label for="radioCiclonico">Radio (m)</label><input type="number" id="radioCiclonico" step="0.01" value="0.0"><label for="alturaCiclonico">Altura (m)</label><input type="number" id="alturaCiclonico" step="0.01" value="0.8"></div>
                </div>
                <div id="disenoAletasDiv" style="display:none;">
                    <h4>FINS (Aletas)</h4>
                    <div class="input-group">
                        <div class="input-field"><label for="numAletas">N√∫mero de Aletas</label><input type="number" id="numAletas" value="4"></div>
                        <div class="input-field"><label for="largoAletas">Largo Aletas (m)</label><input type="number" id="largoAletas" step="0.01" value="0.6"></div>
                        <div class="input-field"><label for="anchoAletas">Ancho Aletas (m)</label><input type="number" id="anchoAletas" step="0.01" value="0.05"></div>
                    </div>
                </div>
                <div class="input-field" style="margin-top: 20px;"><button class="btn btn-primary" onclick="calcularDisenoGeometrico()">Calcular √Årea Total y Validar</button></div>
                <div id="resultados6" class="calculation-display" style="display:none;"></div>
                <div class="buttons">
                    <button class="btn btn-secondary" onclick="siguientePaso(5)">‚Üê Anterior</button>
                    <button class="btn btn-primary" id="siguiente6" onclick="handleFinalize()" disabled>Finalizar y Generar Reporte ‚Üí</button>
                </div>
            </div>

            <div class="step-card" id="step7">
                <div class="step-title"><div class="step-number">7</div>FICHA T√âCNICA DE DISE√ëO</div>
                <div class="final-report" id="reporteFinal"></div>
                <div class="buttons">
                    <button class="btn btn-secondary" onclick="siguientePaso(6)">‚Üê Anterior</button>
                    <button class="btn btn-primary" id="pdfButton" onclick="descargarPDF()">üìÑ Descargar Ficha en PDF</button>
                    <button class="btn btn-primary" onclick="reiniciarCalculo()">üîÑ Nuevo C√°lculo (F5)</button>
                </div>
            </div>
        </main>
    </div>
    
    <footer class="page-footer">
        <a href="https://github.com/legend20021" target="_blank" rel="noopener noreferrer">
            <svg viewBox="0 0 16 16" version="1.1" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg>
            Desarrollado por Jonathan Jerez (legend20021) | Ingeniero Mec√°nico
        </a>
    </footer>

    <script>
        window.jsPDF = window.jspdf.jsPDF;
        let resultados = {};

        function siguientePaso(paso) {
            document.querySelectorAll('.step-card').forEach(card => card.classList.remove('active'));
            document.getElementById(`step${paso}`).classList.add('active');
            window.scrollTo(0, 0);
            
            if (paso === 3) {
                calcularPaso3();
            }

            const titulos = ["Req. T√©rmicos", "Balance Biomasa", "Aire Combusti√≥n", "√Årea de Transferencia", "Dise√±o Aletas", "Dise√±o Geom√©trico", "Reporte Final"];
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = (paso / 7) * 100 + '%';
            progressBar.textContent = `Paso ${paso} de 7: ${titulos[paso-1]}`;
        }

        function calcularPaso1() {
            const aireCFM = parseFloat(document.getElementById('aireCFM').value);
            const tempAmbiente = parseFloat(document.getElementById('tempAmbiente').value);
            const tempSalida = parseFloat(document.getElementById('tempSalida').value);
            const cpBiomasa = parseFloat(document.getElementById('biomassType').value);
            const humedadBiomasa = parseFloat(document.getElementById('humedadBiomasa').value);
            const eficienciaHorno = parseFloat(document.getElementById('eficienciaHorno').value);
            const horasTrabajo = parseFloat(document.getElementById('horasTrabajo').value);

            const m_aire = aireCFM * 0.00055;
            const cp_aire = 1.05;
            const deltaT = tempSalida - tempAmbiente;
            
            const Q_proceso = m_aire * cp_aire * deltaT;
            const Q_horno_requerido = Q_proceso / (eficienciaHorno / 100);
            const Q_horno_btu = Q_horno_requerido * 3412.14;
            
            const cpBiomasa_efectivo = cpBiomasa * (1 - humedadBiomasa / 100);
            const m_cisco_total = (Q_horno_requerido * horasTrabajo * 3600) / cpBiomasa_efectivo;
            const consumo_por_hora = m_cisco_total / horasTrabajo;
            const consumo_por_minuto = consumo_por_hora / 60;

            resultados.paso1 = { m_aire, deltaT, Q_proceso, Q_horno_requerido, Q_horno_btu, cpBiomasa_efectivo, m_cisco_total, consumo_por_hora, consumo_por_minuto, aireCFM, horasTrabajo, eficienciaHorno, humedadBiomasa, biomassType: {value: cpBiomasa, text: document.getElementById('biomassType').selectedOptions[0].text} };

            document.getElementById('resultados1').innerHTML = `
                <h4>üìä Resultados Termodin√°micos:</h4>
                <div class="result-highlight">
                    <strong>Potencia Requerida del Horno: ${Q_horno_requerido.toFixed(2)} kW / ${Q_horno_btu.toLocaleString('en-US', {maximumFractionDigits:0})} BTU/hr</strong><br>
                    <small>(Considerando ${eficienciaHorno}% de eficiencia para entregar ${Q_proceso.toFixed(2)} kW √∫tiles al proceso)</small><br><br>
                    <strong>Poder calor√≠fico efectivo (Biomasa al ${humedadBiomasa}% hum.):</strong> ${cpBiomasa_efectivo.toFixed(0)} kJ/kg<br>
                    <strong>Biomasa total necesaria para ${horasTrabajo}h:</strong> ${m_cisco_total.toFixed(1)} kg<br>
                    <strong>Consumo de biomasa por hora:</strong> ${consumo_por_hora.toFixed(2)} kg/h
                </div>`;
            document.getElementById('resultados1').style.display = 'block';
            document.getElementById('siguiente1').disabled = false;
        }

        function calcularPaso2() {
            const cafeCapacidad = parseFloat(document.getElementById('cafeCapacidad').value);
            const volumenMaquina = parseFloat(document.getElementById('volumenMaquina').value);
            const porcentajeCisco = parseFloat(document.getElementById('porcentajeCisco').value);
            
            const cps_final = cafeCapacidad * 0.5;
            const cisco_generado = cps_final * (porcentajeCisco / 100);
            const cisco_total_req = resultados.paso1.m_cisco_total;
            const cisco_a_comprar = Math.max(0, cisco_total_req - cisco_generado);
            const porcentaje_cubierto = Math.min(100, (cisco_generado / cisco_total_req) * 100);
            const porcentaje_a_comprar = 100 - porcentaje_cubierto;

            resultados.paso2 = { cafeCapacidad, volumenMaquina, cisco_generado, cisco_a_comprar, porcentaje_a_comprar };

            document.getElementById('resultados2').innerHTML = `
                <h4>‚òï Resultados del Balance de Biomasa:</h4>
                <div class="result-highlight">
                    <strong>Biomasa requerida por el horno:</strong> ${cisco_total_req.toFixed(1)} kg<br>
                    <strong>Cisco generado en el proceso de secado:</strong> ${cisco_generado.toFixed(1)} kg<br>
                    <strong>Porcentaje cubierto con cisco propio:</strong> ${porcentaje_cubierto.toFixed(1)}%<br>
                    <strong style="color:${cisco_a_comprar > 0 ? 'red' : 'green'};">Biomasa que se necesita comprar: ${cisco_a_comprar.toFixed(1)} kg (${porcentaje_a_comprar > 0 ? porcentaje_a_comprar.toFixed(1) : '0'}%)</strong>
                </div>`;
            document.getElementById('resultados2').style.display = 'block';
            document.getElementById('siguiente2').disabled = false;
        }
        
        function calcularPaso3() {
            const aire_requerido_kgmin = resultados.paso1.consumo_por_minuto * 20;
            const aire_combustion_cfm = aire_requerido_kgmin * 32;
            resultados.paso3 = { aire_combustion_cfm };
            document.getElementById('resultados3').innerHTML = `
                <h4>üî• Resultados de Aire para Combusti√≥n:</h4>
                <div class="result-highlight">
                    <strong>Consumo de combustible:</strong> ${resultados.paso1.consumo_por_minuto.toFixed(3)} kg/min<br>
                    <strong>Aire requerido para combusti√≥n:</strong> ${aire_requerido_kgmin.toFixed(2)} kg/min
                </div>
                <div class="warning">
                    üí° Se recomienda un <strong>ventilador de combusti√≥n</strong> (secundario, no el de proceso) con una capacidad de al menos <strong>${aire_combustion_cfm.toFixed(1)} CFM</strong>.
                </div>`;
             document.getElementById('resultados3').style.display = 'block';
        }

        function calcularTransferencia() {
            const h = parseFloat(document.getElementById('coeficienteH').value);
            const emissividad = parseFloat(document.getElementById('emissividad').value);
            const tempSuperficie = parseFloat(document.getElementById('tempSuperficie').value);
            const areaComun = parseFloat(document.getElementById('areaComun').value);
            
            const deltaT = 45;
            const sigma = 5.67e-8;
            const tempSuperficieK = tempSuperficie + 273.15;
            const tempAireK = 312.5 + 273.15;

            const Q_conv = h * areaComun * deltaT;
            const Q_rad = areaComun * emissividad * sigma * (Math.pow(tempSuperficieK, 4) - Math.pow(tempAireK, 4));
            const Q_total = (Q_conv + Q_rad) / 1000;

            resultados.paso4 = { areaComun, Q_total, Q_horno_requerido: resultados.paso1.Q_horno_requerido, tempSuperficie };
            
            const diferencia = Math.abs(Q_total - resultados.paso4.Q_horno_requerido);
            const porcentajeError = (diferencia / resultados.paso4.Q_horno_requerido) * 100;
            
            document.getElementById('objetivoCalor').innerHTML = `üéØ <strong>OBJETIVO DE POTENCIA DEL HORNO:</strong> <span class="objetivo-highlight">${resultados.paso1.Q_horno_requerido.toFixed(2)} kW</span>`;
            document.getElementById('objetivoCalor').style.display = 'block';

            document.getElementById('resultados4').innerHTML = `
                <h4>üå°Ô∏è Transferencia de Calor Calculada:</h4>
                <div class="result-highlight">
                    <strong>Q total transferido con ${areaComun.toFixed(2)} m¬≤:</strong> ${Q_total.toFixed(2)} kW<br>
                    <strong>Diferencia vs. Objetivo:</strong> ${diferencia.toFixed(2)} kW (${porcentajeError.toFixed(1)}%)
                </div>
                <div class="warning">
                    ${porcentajeError > 5 ? `‚ö†Ô∏è AJUSTAR √ÅREA: La diferencia es > 5%.` : `‚úÖ VALIDADO: El √°rea de transferencia es adecuada.`}
                </div>`;
            document.getElementById('resultados4').style.display = 'block';
            if (porcentajeError <= 5) {
                document.getElementById('siguiente4').disabled = false;
            } else {
                 document.getElementById('siguiente4').disabled = true;
            }
        }

        function iterarArea() {
            const Q_requerido_W = resultados.paso1.Q_horno_requerido * 1000;
            const h = parseFloat(document.getElementById('coeficienteH').value);
            const emissividad = parseFloat(document.getElementById('emissividad').value);
            const tempSuperficie = parseFloat(document.getElementById('tempSuperficie').value);
            const deltaT = 45;
            const sigma = 5.67e-8;
            const tempSuperficieK = tempSuperficie + 273.15;
            const tempAireK = 312.5 + 273.15;
            let areaEstimada = Q_requerido_W / (h * deltaT + emissividad * sigma * (Math.pow(tempSuperficieK, 4) - Math.pow(tempAireK, 4)));
            document.getElementById('areaComun').value = areaEstimada.toFixed(2);
            calcularTransferencia();
        }

        function toggleAletas() {
            const usarAletas = document.getElementById('usarAletas').checked;
            document.getElementById('aletas-params-div').style.display = usarAletas ? 'block' : 'none';
            document.getElementById('disenoAletasDiv').style.display = usarAletas ? 'block' : 'none';
            if (!usarAletas) {
                resultados.paso5 = { usarAletas: false };
                document.getElementById('resultados5').style.display = 'none';
            }
        }
        
        function calcularDisenoAletas() {
            const K = parseFloat(document.getElementById('aletaK').value);
            const Ac_mm2 = parseFloat(document.getElementById('aletaAc').value);
            const h = parseFloat(document.getElementById('aletaH').value);
            const P_mm = parseFloat(document.getElementById('aletaP').value);
            const Ac_m2 = Ac_mm2 / 1000000;
            const P_m = P_mm / 1000;
            const L_min = 2.65 * Math.sqrt((K * Ac_m2) / (h * P_m));
            resultados.paso5 = { usarAletas: true, L_min };
            document.getElementById('resultados5').innerHTML = `
                <h4>üìè Resultados de Aleta √ìptima:</h4>
                <div class="result-highlight">
                    <strong>Longitud m√≠nima recomendada de aleta:</strong> ${(L_min * 100).toFixed(1)} cm
                </div>`;
            document.getElementById('resultados5').style.display = 'block';
        }

        function calcularDisenoGeometrico() {
            if (!resultados.paso4 || typeof resultados.paso4.areaComun === 'undefined') {
                document.getElementById('resultados6').innerHTML = `<div class="warning"><h4>Error de Flujo de Trabajo</h4><p>Debe completar el <strong>Paso 4 (Transferencia de Calor)</strong> y obtener un √°rea requerida v√°lida antes de poder validar el dise√±o geom√©trico.</p></div>`;
                document.getElementById('resultados6').style.display = 'block';
                return; 
            }

            const radioPrincipal = parseFloat(document.getElementById('radioPrincipal').value);
            const alturaPrincipal = parseFloat(document.getElementById('alturaPrincipal').value);
            const radioCiclonico = parseFloat(document.getElementById('radioCiclonico').value);
            const alturaCiclonico = parseFloat(document.getElementById('alturaCiclonico').value);
            const usarAletas = document.getElementById('usarAletas').checked;
            const areaCilindroPrincipal = 2 * Math.PI * radioPrincipal * alturaPrincipal;
            const areaCilindroCiclonico = radioCiclonico > 0 ? 2 * Math.PI * radioCiclonico * alturaCiclonico : 0;
            let areaAletas = 0;
            let numAletas=0, largoAletas=0, anchoAletas=0, validacionAletas = true, mensajeAletasError = '';
            
            if (usarAletas) {
                if (!resultados.paso5 || typeof resultados.paso5.L_min === 'undefined') {
                    validacionAletas = false;
                    mensajeAletasError = 'Debe calcular primero la longitud m√≠nima en el Paso 5.';
                } else {
                    numAletas = parseFloat(document.getElementById('numAletas').value);
                    largoAletas = parseFloat(document.getElementById('largoAletas').value);
                    anchoAletas = parseFloat(document.getElementById('anchoAletas').value);
                    areaAletas = numAletas * largoAletas * anchoAletas * 2;
                    if (largoAletas < resultados.paso5.L_min) {
                        validacionAletas = false;
                        mensajeAletasError = `El largo de aletas (${(largoAletas*100).toFixed(1)} cm) es MENOR al m√≠nimo recomendado (${(resultados.paso5.L_min*100).toFixed(1)} cm).`;
                    }
                }
            }
            
            const areaTotal = areaCilindroPrincipal + areaCilindroCiclonico + areaAletas;
            const areaRequerida = resultados.paso4.areaComun;
            const validacionArea = areaTotal >= areaRequerida;
            resultados.paso6 = { radioPrincipal, alturaPrincipal, radioCiclonico, areaCilindroPrincipal, areaCilindroCiclonico, areaAletas, areaTotal, numAletas, largoAletas, anchoAletas, validacionArea, validacionAletas };
            
            let isDesignValid = validacionArea && validacionAletas;
            let validationMessageHTML = `
                <h4>üìê Resultados del Dise√±o Geom√©trico:</h4>
                <div class="result-highlight">
                    <strong>√ÅREA TOTAL DISE√ëADA: ${areaTotal.toFixed(2)} m¬≤</strong> (Requerida: ${areaRequerida.toFixed(2)} m¬≤)
                </div>
                <div class="warning">
                    <p><strong>Validaci√≥n de √Årea:</strong> ${validacionArea ? '‚úÖ CUMPLE' : `‚ùå INSUFICIENTE - Se requieren ${areaRequerida.toFixed(2)} m¬≤.`}</p>
                    ${usarAletas ? `<p><strong>Validaci√≥n de Aletas:</strong> ${validacionAletas ? '‚úÖ ADECUADAS' : `‚ùå INV√ÅLIDAS - ${mensajeAletasError}`}</p>` : ''}
                    <br>
                    ${isDesignValid ? 
                        '<p style="color:green; font-weight:bold;">¬°Dise√±o v√°lido! Ya puede generar el reporte final.</p>' : 
                        '<p style="color:red; font-weight:bold;">El dise√±o no es v√°lido. Corrija los puntos marcados con ‚ùå para poder continuar.</p>'}
                </div>`;

            document.getElementById('resultados6').innerHTML = validationMessageHTML;
            document.getElementById('resultados6').style.display = 'block';
            document.getElementById('siguiente6').disabled = !isDesignValid;
        }

        function handleFinalize() {
            try {
                generarReporteFinal();
            } catch (error) {
                console.error("Error al generar el reporte final:", error);
                document.getElementById('reporteFinal').innerHTML = `<div class="warning"><h4>Ocurri√≥ un error al generar el reporte.</h4><p>Aseg√∫rese de haber completado todos los pasos en orden. Error: ${error.message}</p></div>`;
            }
            siguientePaso(7);
        }

        function generarReporteFinal() {
            const r = resultados;
            const heatFlux = r.paso1.Q_horno_requerido / r.paso6.areaTotal;
            const relacionAspecto = r.paso6.alturaPrincipal / (r.paso6.radioPrincipal * 2);
            const aporteAletas = r.paso6.areaAletas > 0 ? (r.paso6.areaAletas / r.paso6.areaTotal) * 100 : 0;

            let recomendacionesHTML = `
                <li>La relaci√≥n altura/di√°metro del horno es <strong>${relacionAspecto.toFixed(1)}</strong>. Valores entre 2 y 4 favorecen una buena circulaci√≥n de gases y una combusti√≥n m√°s estable.</li>
                <li>El flujo de calor es de <strong>${heatFlux.toFixed(2)} kW/m¬≤</strong>. Este valor es clave para seleccionar el espesor del acero y el tipo de aislamiento t√©rmico. Un flujo muy alto puede requerir materiales m√°s robustos.</li>
                ${aporteAletas > 0 ? `<li>Las aletas aportan un <strong>${aporteAletas.toFixed(1)}%</strong> del √°rea total de transferencia. Son un m√©todo efectivo para aumentar la transferencia sin alterar dr√°sticamente el cuerpo principal del horno.</li>` : ''}
                `;
            
            if (r.paso6.areaAletas <= 0) {
                 recomendacionesHTML += `<li><b>Considere a√±adir aletas:</b> Las aletas aumentan el √°rea de contacto con el aire sin agrandar el horno, mejorando significativamente la eficiencia t√©rmica.</li>`;
            }

            if (r.paso2.cisco_a_comprar > 0) {
                recomendacionesHTML += `<li>Dado que se debe adquirir un <strong>${r.paso2.porcentaje_a_comprar.toFixed(1)}%</strong> de la biomasa, es crucial asegurar proveedores locales con antelaci√≥n.</li>`;
            }

            document.getElementById('reporteFinal').innerHTML = `
                <div class="report-section">
                    <h3>FICHA T√âCNICA DE DISE√ëO: Horno de Biomasa</h3>
                    <table class="report-table">
                        <tr><td>Fecha de C√°lculo</td><td>${new Date().toLocaleDateString('es-CO')}</td></tr>
                        <tr><td>Tipo de Biomasa</td><td>${r.paso1.biomassType.text.split('(')[0].trim()}</td></tr>
                    </table>
                </div>

                <div class="report-section">
                    <h3>Especificaciones de Rendimiento T√©rmico</h3>
                    <table class="report-table">
                        <tr><td>Potencia del Horno</td><td><strong>${r.paso1.Q_horno_requerido.toFixed(2)} kW / ${r.paso1.Q_horno_btu.toLocaleString('en-US', {maximumFractionDigits:0})} BTU/hr</strong></td></tr>
                        <tr><td>Eficiencia de Dise√±o</td><td>${r.paso1.eficienciaHorno}%</td></tr>
                        <tr><td>Temperatura de Superficie</td><td>${r.paso4.tempSuperficie}¬∞C</td></tr>
                        <tr><td>Flujo de Calor (Heat Flux)</td><td>${heatFlux.toFixed(2)} kW/m¬≤</td></tr>
                    </table>
                </div>

                 <div class="report-section">
                    <h3>Par√°metros Clave de Operaci√≥n</h3>
                     <table class="report-table">
                        <tr><td>Potencia √ötil al Proceso</td><td>${r.paso1.Q_proceso.toFixed(2)} kW</td></tr>
                        <tr><td>Flujo M√°sico de Aire</td><td>${r.paso1.m_aire.toFixed(3)} kg/s</td></tr>
                        <tr><td>Incremento de Temperatura (ŒîT)</td><td>${r.paso1.deltaT.toFixed(1)} ¬∞C</td></tr>
                        <tr><td>Consumo de Biomasa</td><td>${r.paso1.consumo_por_hora.toFixed(2)} kg/h</td></tr>
                     </table>
                </div>

                <div class="report-section">
                    <h3>Par√°metros Constructivos y Geom√©tricos</h3>
                     <table class="report-table">
                        <tr><td>Cilindro Principal</td><td>√ò${(r.paso6.radioPrincipal * 2 * 100).toFixed(0)} cm √ó ${r.paso6.alturaPrincipal.toFixed(2)} m</td></tr>
                        <tr><td>√Årea Cilindro Principal</td><td>${r.paso6.areaCilindroPrincipal.toFixed(2)} m¬≤</td></tr>
                        <tr><td>√Årea Filtro Cicl√≥nico</td><td>${r.paso6.radioCiclonico > 0 ? `${r.paso6.areaCilindroCiclonico.toFixed(2)} m¬≤` : 'No utilizado'}</td></tr>
                        <tr><td>Aletas</td><td>${(r.paso6.areaAletas > 0) ? `${r.paso6.numAletas} uds. (${r.paso6.areaAletas.toFixed(2)} m¬≤)` : 'No utilizadas'}</td></tr>
                        <tr><td>√Årea de Transferencia Total</td><td><strong>${r.paso6.areaTotal.toFixed(2)} m¬≤</strong></td></tr>
                        <tr><td>Ventilador de Proceso</td><td>${r.paso1.aireCFM} CFM</td></tr>
                        <tr><td>Ventilador de Combusti√≥n</td><td>${r.paso3.aire_combustion_cfm.toFixed(1)} CFM</td></tr>
                     </table>
                </div>

                <div class="report-section">
                    <h3>Materiales Sugeridos y Seguridad</h3>
                     <table class="report-table">
                        <tr><td>Material Estructural</td><td>Acero al Carbono (ej. ASTM A36)</td></tr>
                        <tr><td>Zonas de Alta Temperatura</td><td>Acero Inoxidable (ej. 304 / 310)</td></tr>
                        <tr><td>Aislamiento T√©rmico</td><td>Lana de Roca o Fibra Cer√°mica (2-4 pulgadas)</td></tr>
                        <tr><td>Seguridad Esencial</td><td>Chimenea de altura adecuada, control de tiro (damper), puerta con sello herm√©tico.</td></tr>
                     </table>
                </div>

                 <div class="report-section">
                    <h3>Recomendaciones de Dise√±o e Implementaci√≥n</h3>
                     <ul>${recomendacionesHTML}</ul>
                </div>
                <div class="report-footer">
                    Herramienta desarrollada por Jonathan Jerez, Ingeniero Mec√°nico.
                </div>`;
        }

        function descargarPDF() {
            const pdfButton = document.getElementById('pdfButton');
            const originalText = pdfButton.innerHTML;
            pdfButton.innerHTML = 'Generando PDF...';
            pdfButton.disabled = true;

            const reporte = document.getElementById('reporteFinal');
            const { jsPDF } = window.jspdf;

            html2canvas(reporte, { scale: 2, useCORS: true }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                
                const imgProps= pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                
                let heightLeft = pdfHeight;
                let position = 0;
                
                pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
                heightLeft -= pdf.internal.pageSize.getHeight();

                while (heightLeft > 0) {
                  position -= pdf.internal.pageSize.getHeight();
                  pdf.addPage();
                  pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
                  heightLeft -= pdf.internal.pageSize.getHeight();
                }
                
                pdf.save(`Ficha-Tecnica-Horno-${new Date().toISOString().slice(0,10)}.pdf`);
                pdfButton.innerHTML = originalText;
                pdfButton.disabled = false;

            }).catch(error => {
                console.error("Error al generar el PDF:", error);
                alert("Ocurri√≥ un error al generar el PDF. Aseg√∫rese de tener conexi√≥n a internet y vuelva a intentarlo.");
                pdfButton.innerHTML = originalText;
                pdfButton.disabled = false;
            });
        }
        
        function reiniciarCalculo() {
            location.reload();
        }
    </script>
</body>
</html>