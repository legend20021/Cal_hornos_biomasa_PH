<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herramienta Profesional de C√°lculo de Hornos v8.4 (Penagos Edition)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Segoe+UI:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #111827;
            color: #E5E7EB;
            overflow: hidden;
        }

        /* --- Estilos de la Pantalla de Login --- */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10000; display: flex; align-items: center; justify-content: center;
            background-color: #111827;
            transition: opacity 0.8s ease-in-out;
        }
        #login-overlay.hidden { opacity: 0; pointer-events: none; }
        .login-box {
            background: rgba(31, 41, 55, 0.5); border: 1px solid rgba(34, 211, 238, 0.3);
            padding: 40px; border-radius: 15px; -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px);
            text-align: center; color: #fff; width: 90%; max-width: 420px;
            animation: fadeInLogin 1s ease-out;
        }
        @keyframes fadeInLogin { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .login-logo { max-width: 200px; margin-bottom: 20px; }
        .login-box h1 {
            font-family: 'Orbitron', sans-serif; font-size: 24px; margin-bottom: 10px;
            color: #22d3ee; text-shadow: 0 0 10px #22d3ee;
        }
        .login-box p { margin-bottom: 30px; color: rgba(229, 231, 235, 0.7); }
        .login-field { margin-bottom: 20px; text-align: left; }
        .login-field label { display: block; margin-bottom: 8px; color: rgba(229, 231, 235, 0.8); font-size: 14px; }
        .login-field input {
            width: 100%; padding: 12px; background: rgba(17, 24, 39, 0.8);
            border: 1px solid rgba(34, 211, 238, 0.4); border-radius: 8px;
            color: #fff; font-size: 16px; transition: all 0.3s ease;
        }
        .login-field input:focus {
            outline: none; border-color: #22d3ee;
            box-shadow: 0 0 15px rgba(34, 211, 238, 0.5);
        }
        .login-button {
            width: 100%; padding: 12px; border: none; border-radius: 8px; background: #22d3ee;
            color: #111827; font-size: 18px; font-weight: bold; font-family: 'Orbitron', sans-serif;
            cursor: pointer; transition: all 0.3s ease; box-shadow: 0 0 10px rgba(34, 211, 238, 0.5);
        }
        .login-button:hover { background: #fff; box-shadow: 0 0 25px #22d3ee; }
        .login-box.error-shake { animation: shake 0.5s; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); } 20%, 40%, 60%, 80% { transform: translateX(10px); }
        }
        .particles { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: -1; }
        .particles li {
            position: absolute; display: block; list-style: none; width: 20px; height: 20px;
            background: rgba(34, 211, 238, 0.2); animation: animate-particles 25s linear infinite; bottom: -150px;
        }
        .particles li:nth-child(1){ left: 25%; width: 30px; height: 30px; animation-delay: 0s; } .particles li:nth-child(2){ left: 10%; width: 20px; height: 20px; animation-delay: 2s; animation-duration: 12s; } .particles li:nth-child(3){ left: 70%; width: 20px; height: 20px; animation-delay: 4s; } .particles li:nth-child(4){ left: 40%; width: 60px; height: 60px; animation-delay: 0s; animation-duration: 18s; } .particles li:nth-child(5){ left: 65%; width: 20px; height: 20px; animation-delay: 0s; } .particles li:nth-child(6){ left: 75%; width: 40px; height: 40px; animation-delay: 3s; } .particles li:nth-child(7){ left: 35%; width: 50px; height: 50px; animation-delay: 7s; } .particles li:nth-child(8){ left: 50%; width: 25px; height: 25px; animation-delay: 15s; animation-duration: 45s; } .particles li:nth-child(9){ left: 20%; width: 15px; height: 15px; animation-delay: 2s; animation-duration: 35s; } .particles li:nth-child(10){ left: 85%; width: 60px; height: 60px; animation-delay: 0s; animation-duration: 11s; }
        @keyframes animate-particles { 0%{ transform: translateY(0) rotate(0deg); opacity: 1; border-radius: 0; } 100%{ transform: translateY(-1000px) rotate(720deg); opacity: 0; border-radius: 50%; } }

        /* --- Estilos Unificados de la Herramienta Principal --- */
        .app-wrapper {
            opacity: 0; transform: translateY(20px);
            transition: opacity 0.5s 0.4s ease-out, transform 0.5s 0.4s ease-out;
            padding-bottom: 90px; /* Aumentado para dejar espacio al footer */
        }
        .app-wrapper.visible { opacity: 1; transform: translateY(0); }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; color: white; margin: 20px 0; display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .header-logo { max-width: 250px; }
        .progress-bar { background: rgba(31, 41, 55, 0.5); border-radius: 25px; height: 50px; margin: 20px 0; position: relative; overflow: hidden; }
        .progress-fill { background: linear-gradient(90deg, #22d3ee, #00bfff); height: 100%; border-radius: 25px; transition: width 0.5s ease; display: flex; align-items: center; justify-content: center; color: #111827; font-weight: bold; }
        .step-card {
            background: rgba(31, 41, 55, 0.5); border: 1px solid rgba(34, 211, 238, 0.3);
            -webkit-backdrop-filter: blur(5px); backdrop-filter: blur(5px);
            color: #E5E7EB; border-radius: 15px; padding: 30px; margin: 20px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: none; animation: slideIn 0.5s ease;
        }
        .step-card.active { display: block; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .step-title { color: #22d3ee; font-size: 24px; margin-bottom: 20px; display: flex; align-items: center; }
        .step-number { background: #22d3ee; color: #111827; min-width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-weight: bold; }
        .input-group { margin: 20px 0; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; align-items: start; }
        .input-field { display: flex; flex-direction: column; }
        .input-field h4 { color: #93c5fd; margin-bottom: 15px; padding-bottom: 5px; border-bottom: 1px solid #3b82f6; }
        label { font-weight: bold; margin-bottom: 5px; color: #d1d5db; }
        label small { font-weight: normal; color: #9ca3af; display: block; margin-top: 4px; line-height: 1.4; }
        input, select {
            padding: 12px; border-radius: 8px; font-size: 16px; transition: all 0.3s; width: 100%;
            background: rgba(17, 24, 39, 0.8); color: #fff; border: 1px solid rgba(34, 211, 238, 0.4);
        }
        input:focus, select:focus { outline: none; border-color: #22d3ee; box-shadow: 0 0 15px rgba(34, 211, 238, 0.5); }
        .calculation-display { background: #1f2937; border: 1px solid rgba(34, 211, 238, 0.3); border-radius: 10px; padding: 20px; margin: 15px 0; }
        .result-highlight { background: #374151; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #22d3ee; }
        .objetivo-highlight { background: #1e40af; color: #dbeafe; font-weight: bold; padding: 10px; border-radius: 8px; border-left: 4px solid #3b82f6; }
        .buttons { display: flex; justify-content: space-between; align-items: center; margin-top: 30px; gap: 15px; flex-wrap: wrap; }
        .button-group { display: flex; gap: 10px; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; transition: all 0.3s; font-weight: bold; }
        .btn-primary { background: #22d3ee; color: #111827; }
        .btn-primary:hover { background: #fff; transform: translateY(-2px); box-shadow: 0 0 20px #22d3ee; }
        .btn-secondary { background: #4b5563; color: #e5e7eb; }
        .btn-secondary:hover { background: #6b7280; }
        .btn:disabled { background: #374151; color: #9ca3af; cursor: not-allowed; transform: none; animation: none !important; box-shadow: none; }
        .next-button-pulse:not(:disabled) { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 211, 238, 0.7); } 70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(34, 211, 238, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 211, 238, 0); } }
        .final-report { background: #1f2937; color: #e5e7eb; padding: 30px; border-radius: 15px; margin: 20px 0; border: 1px solid rgba(34, 211, 238, 0.3); }
        .report-section h3 { color: #22d3ee; margin-top: 20px; border-bottom: 2px solid #22d3ee; padding-bottom: 5px; margin-bottom: 15px;}
        .report-section ul { list-style-position: inside; padding-left: 5px; }
        .report-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .report-table td { padding: 8px; border: 1px solid #4b5563; font-size: 14px; }
        .report-table td:first-child { font-weight: bold; background-color: #374151; width: 50%; }
        .report-footer { margin-top: 30px; padding-top: 15px; border-top: 1px solid #4b5563; text-align: center; font-size: 12px; color: #9ca3af; }
        .warning { background: #3730a3; color: #e0e7ff; border: 1px solid #4f46e5; border-radius: 8px; padding: 15px; margin: 15px 0; }
        .toggle-container { display: flex; align-items: center; gap: 10px; margin: 20px 0; }
        #aletas-params-div { display: none; }
        .formula-display { background: #1e3a8a; color: #dbeafe; padding: 10px; border-radius: 8px; margin: 10px 0; font-family: monospace; }
        
        /* --- Estilos del Footer --- */
        .page-footer {
            position: fixed;
            bottom: 0; left: 0; width: 100%; z-index: 1000;
            background-color: rgba(17, 24, 39, 0.85);
            -webkit-backdrop-filter: blur(8px); backdrop-filter: blur(8px);
            padding: 15px 25px;
            color: rgba(229, 231, 235, 0.8);
            border-top: 1px solid rgba(34, 211, 238, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }
        .footer-left a {
            color: #E5E7EB; text-decoration: none; font-weight: bold;
            display: inline-flex; align-items: center; gap: 8px;
            transition: color 0.3s;
        }
        .footer-left a:hover { color: #22d3ee; }
        .footer-left svg { width: 22px; height: 22px; fill: currentColor; }
        .footer-right { font-weight: bold; color: #9ca3af; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <ul class="particles">
            <li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li>
        </ul>
        <div class="login-box" id="loginBox">
            <img src="https://penagos.com/wp-content/uploads/2020/04/logo-2-300x129.png" alt="Logo Penagos" class="login-logo">
            <h1>Acceso al Sistema</h1>
            <p>Herramienta de Dise√±o de Hornos v8.4</p>
            <form id="login-form">
                <div class="login-field">
                    <label for="username">Usuario</label>
                    <input type="text" id="username" placeholder="Ingrese su usuario" value="PENAGOS">
                </div>
                <div class="login-field">
                    <label for="password">Contrase√±a</label>
                    <input type="password" id="password" placeholder="Ingrese su contrase√±a">
                </div>
                <button type="submit" class="login-button">Ingresar</button>
            </form>
        </div>
    </div>

    <div class="app-wrapper" id="appWrapper">
        <div class="container">
            <header class="header">
                 <img src="https://penagos.com/wp-content/uploads/2020/04/logo-2-300x129.png" alt="Logo Penagos" class="header-logo">
                <h1>üîß Herramienta Profesional de C√°lculo de Hornos v8.4</h1>
                <p>Dise√±o paso a paso para sistemas de combusti√≥n de biomasa</p>
            </header>
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar">Paso 1 de 7</div>
            </div>

            <main>
                <div class="step-card active" id="step1">
                    <div class="step-title"><div class="step-number">1</div>REQUERIMIENTOS T√âRMICOS Y DE BIOMASA</div>
                     <div class="input-group">
                        <div class="input-field"><label for="aireCFM">Aire de Proceso (CFM)<small>Capacidad del ventilador principal.</small></label><input type="number" id="aireCFM" value="700"></div>
                        <div class="input-field"><label for="tempAmbiente">Temperatura Ambiente (¬∞C)<small>Temperatura del aire antes de calentarse.</small></label><input type="number" id="tempAmbiente" value="15"></div>
                        <div class="input-field"><label for="tempSalida">Temperatura de Salida (¬∞C)<small>Temperatura deseada para el proceso.</small></label><input type="number" id="tempSalida" value="60"></div>
                    </div>
                     <div class="input-group">
                        <div class="input-field"><label for="biomassType">Tipo de Biomasa<small>Seleccione el combustible a utilizar.</small></label><select id="biomassType"><option value="18000">Cisco de Caf√© (18,000 kJ/kg)</option><option value="17500">Cascarilla de Caf√© (17,500 kJ/kg)</option><option value="15000">Cascarilla de Arroz (15,000 kJ/kg)</option><option value="19200">Bagazo de Ca√±a (19,200 kJ/kg)</option><option value="20500">Residuos de Palma (20,500 kJ/kg)</option></select></div>
                        <div class="input-field"><label for="humedadBiomasa">Humedad Biomasa (%)<small>Contenido de agua en el combustible.</small></label><input type="number" id="humedadBiomasa" value="12"></div>
                        <div class="input-field"><label for="eficienciaHorno">Eficiencia del Horno (%)<small>P√©rdidas de calor (t√≠pico 80-90%).</small></label><input type="number" id="eficienciaHorno" value="85"></div>
                     </div>
                     <div class="input-group">
                        <div class="input-field"><label for="horasTrabajo">Horas de Trabajo<small>Total de horas de operaci√≥n del ciclo.</small></label><input type="number" id="horasTrabajo" value="32"></div>
                        <div class="input-field" style="justify-content: end;"><button class="btn btn-primary" onclick="calcularPaso1()">Calcular Requerimientos</button></div>
                     </div>
                    <div id="resultados1" class="calculation-display" style="display:none;"></div>
                    <div class="buttons">
                        <button class="btn btn-secondary" disabled>‚Üê Anterior</button>
                        <button class="btn btn-primary" id="siguiente1" onclick="siguientePaso(2)" disabled>Siguiente ‚Üí</button>
                    </div>
                </div>

                <div class="step-card" id="step2">
                    <div class="step-title"><div class="step-number">2</div>BALANCE DE BIOMASA GENERADA VS REQUERIDA</div>
                    <div class="input-group">
                        <div class="input-field"><label for="volumenMaquina">Volumen M√°quina (m¬≥)<small>Capacidad volum√©trica del secador.</small></label><input type="number" id="volumenMaquina" step="0.1" value="1.5"></div>
                        <div class="input-field"><label for="densidadCafe">Densidad Caf√© Lavado (kg/m¬≥)<small>Densidad aparente del caf√© a secar.</small></label><input type="number" id="densidadCafe" step="1" value="350"></div>
                        <div class="input-field"><label for="porcentajeCisco">% Cisco del CPS Final<small>Porcentaje de residuo del producto seco.</small></label><input type="number" id="porcentajeCisco" value="15" max="100"></div>
                    </div>
                    <div id="resultados2" class="calculation-display" style="display:none;"></div>
                    <div class="buttons">
                        <button class="btn btn-secondary" onclick="siguientePaso(1)">‚Üê Anterior</button>
                        <div class="button-group">
                            <button class="btn btn-secondary" onclick="calcularPaso2()">1. Calcular Balance</button>
                            <button class="btn btn-primary next-button-pulse" id="siguiente2" onclick="siguientePaso(3)" disabled>2. Siguiente ‚Üí</button>
                        </div>
                    </div>
                </div>

                <div class="step-card" id="step3">
                    <div class="step-title"><div class="step-number">3</div>AIRE DE COMBUSTI√ìN (VENTILADOR SECUNDARIO)</div>
                    <div id="resultados3" class="calculation-display" style="display:none;"></div>
                    <div class="buttons">
                        <button class="btn btn-secondary" onclick="siguientePaso(2)">‚Üê Anterior</button>
                        <button class="btn btn-primary next-button-pulse" onclick="siguientePaso(4)">Continuar ‚Üí</button>
                    </div>
                </div>

                <div class="step-card" id="step4">
                    <div class="step-title"><div class="step-number">4</div>TRANSFERENCIA DE CALOR Y √ÅREA REQUERIDA</div>
                    <div id="objetivoCalor" class="calculation-display" style="display:none;"></div>
                    <div class="input-group">
                        <div class="input-field"><label for="coeficienteH">Coeficiente h (W/m¬≤K)<small>Coef. de convecci√≥n (t√≠pico: 100-200).</small></label><input type="number" id="coeficienteH" step="1" value="180"></div>
                        <div class="input-field"><label for="emissividad">Emisividad (Œµ)<small>Radiaci√≥n del material (acero oxidado ‚âà 0.8).</small></label><input type="number" id="emissividad" step="0.01" value="0.8"></div>
                        <div class="input-field"><label for="tempSuperficie">Temp. Superficie (¬∞C)<small>Temperatura externa estimada del horno.</small></label><input type="number" id="tempSuperficie" value="600"></div>
                    </div>
                    <div class="input-group">
                        <div class="input-field"><label for="areaComun">√Årea de Transferencia (m¬≤)<small>Iterar hasta que la transferencia sea v√°lida.</small></label><input type="number" id="areaComun" step="0.1" value="1.0"></div>
                        <div class="input-field" style="justify-content: end;"><button class="btn btn-primary" onclick="calcularTransferencia()">Calcular Transferencia</button></div>
                        <div class="input-field" style="justify-content: end;"><button class="btn btn-secondary" onclick="iterarArea()">Auto-Iterar √Årea</button></div>
                    </div>
                    <div id="resultados4" class="calculation-display" style="display:none;"></div>
                    <div class="buttons">
                        <button class="btn btn-secondary" onclick="siguientePaso(3)">‚Üê Anterior</button>
                        <button class="btn btn-primary next-button-pulse" id="siguiente4" onclick="siguientePaso(5)" disabled>Continuar ‚Üí</button>
                    </div>
                </div>
            
                <div class="step-card" id="step5">
                    <div class="step-title"><div class="step-number">5</div>DISE√ëO √ìPTIMO DE ALETAS (OPCIONAL)</div>
                    <div class="toggle-container">
                        <label for="usarAletas"><strong>Activar c√°lculo de aletas para aumentar el √°rea de transferencia</strong></label>
                        <input type="checkbox" id="usarAletas" onchange="toggleAletas()" style="width: auto; height: 20px;">
                    </div>
                    <div id="aletas-params-div">
                        <div class="formula-display">L_min = 2.65 √ó ‚àö(K √ó Ac / (h √ó P))</div>
                        <div class="input-group">
                            <div class="input-field"><label for="aletaK">Conductividad T√©rmica (K) del Material (W/mK)<small>Ej: Acero al Carbono ‚âà 50</small></label><input type="number" id="aletaK" value="50"></div>
                            <div class="input-field"><label for="aletaH">Coeficiente h (W/m¬≤K)<small>T√≠pico para aire forzado: 100-200</small></label><input type="number" id="aletaH" value="120"></div>
                        </div>
                         <div class="input-group">
                            <div class="input-field"><label for="aletaAc">√Årea Transversal (Ac) de la Aleta (mm¬≤)<small>Ej: platina de 50mm x 3mm = 150</small></label><input type="number" id="aletaAc" value="150"></div>
                            <div class="input-field"><label for="aletaP">Per√≠metro (P) de la Aleta (mm)<small>Ej: platina 50x3mm, P=2*(50+3)=106</small></label><input type="number" id="aletaP" value="106"></div>
                        </div>
                         <div class="input-group">
                            <div class="input-field" style="grid-column: 1 / -1; justify-content: center;"><button class="btn btn-primary" onclick="calcularDisenoAletas()">Calcular Longitud M√≠nima y Pre-llenar en Paso 6</button></div>
                        </div>
                    </div>
                    <div id="resultados5" class="calculation-display" style="display:none;"></div>
                    <div class="buttons">
                        <button class="btn btn-secondary" onclick="siguientePaso(4)">‚Üê Anterior</button>
                        <button class="btn btn-primary next-button-pulse" id="siguiente5" onclick="siguientePaso(6)">Continuar con Dise√±o Geom√©trico ‚Üí</button>
                    </div>
                </div>

                <div class="step-card" id="step6">
                    <div class="step-title"><div class="step-number">6</div>DISE√ëO GEOM√âTRICO, MATERIAL Y VALIDACI√ìN</div>
                    <div class="input-field"><h4>üìê Geometr√≠a del Horno</h4></div>
                    <div class="input-group">
                        <div class="input-field"><h5>üî• Cilindro Principal</h5><label for="radioPrincipal">Radio (m)<small>Radio externo del cilindro principal.</small></label><input type="number" id="radioPrincipal" step="0.01" value="0.15"><label for="alturaPrincipal">Altura (m)<small>Altura total del cilindro principal.</small></label><input type="number" id="alturaPrincipal" step="0.01" value="1.0"></div>
                        <div class="input-field"><h5>üå™Ô∏è C. Cicl√≥nico (Opcional)</h5><label for="radioCiclonico">Radio (m)<small>Dejar en 0 si no se utiliza.</small></label><input type="number" id="radioCiclonico" step="0.01" value="0.0"><label for="alturaCiclonico">Altura (m)<small>Altura del cilindro cicl√≥nico.</small></label><input type="number" id="alturaCiclonico" step="0.01" value="0.8"></div>
                    </div>
                    <div id="disenoAletasDiv" style="display:none;">
                        <div class="input-field"><h4>‚ûï Aletas (Fins)</h4></div>
                        <div class="input-group">
                            <div class="input-field"><label for="numAletas">N√∫mero de Aletas<small>Cantidad total de aletas.</small></label><input type="number" id="numAletas" value="4"></div>
                            <div class="input-field"><label for="largoAletas">Largo Aletas (m)<small>Longitud de cada aleta.</small></label><input type="number" id="largoAletas" step="0.01" value="0.6"></div>
                            <div class="input-field"><label for="anchoAletas">Ancho Aletas (m)<small>Ancho (altura) de cada aleta.</small></label><input type="number" id="anchoAletas" step="0.01" value="0.05"></div>
                        </div>
                    </div>
                    <div class="input-field" style="margin-top: 20px;"><h4>üî© Material y Costo Estimado</h4></div>
                     <div class="input-group">
                        <div class="input-field">
                            <label for="materialType">Material Estructural<small>Seleccione el material principal.</small></label>
                            <select id="materialType">
                                <option value="7850">Acero al Carbono A36 (7850 kg/m¬≥)</option>
                                <option value="8000">Acero Inoxidable 304 (8000 kg/m¬≥)</option>
                            </select>
                        </div>
                        <div class="input-field"><label for="materialThickness">Espesor de L√°mina (mm)<small>Calibre del material a usar.</small></label><input type="number" id="materialThickness" value="3"></div>
                        <div class="input-field"><label for="materialPrice">Precio del Material ($/kg)<small>Costo por kilogramo del material.</small></label><input type="number" id="materialPrice" value="5000"></div>
                     </div>
                    <div class="input-field" style="margin-top: 20px;"><button class="btn btn-primary" onclick="calcularDisenoGeometrico()">Calcular √Årea, Peso, Costo y Validar</button></div>
                    <div id="resultados6" class="calculation-display" style="display:none;"></div>
                    <div class="buttons">
                        <button class="btn btn-secondary" onclick="siguientePaso(5)">‚Üê Anterior</button>
                        <button class="btn btn-primary next-button-pulse" id="siguiente6" onclick="handleFinalize()" disabled>Finalizar y Generar Reporte ‚Üí</button>
                    </div>
                </div>

                <div class="step-card" id="step7">
                    <div class="step-title"><div class="step-number">7</div>FICHA T√âCNICA DE DISE√ëO</div>
                    <div class="final-report" id="reporteFinal"></div>
                    <div class="buttons">
                        <button class="btn btn-secondary" onclick="siguientePaso(6)">‚Üê Anterior</button>
                        <button class="btn btn-primary" id="pdfButton" onclick="descargarPDF()">üìÑ Descargar Ficha en PDF</button>
                        <button class="btn btn-secondary" onclick="reiniciarCalculo()">üîÑ Nuevo C√°lculo</button>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <footer class="page-footer">
        <div class="footer-left">
            <a href="https://github.com/legend20021" target="_blank" rel="noopener noreferrer">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
                <span>Desarrollado por Jonathan Jerez</span>
            </a>
        </div>
        <div class="footer-right" id="copyright">
            &copy; 2024 Penagos Hermanos. Todos los derechos reservados.
        </div>
    </footer>

    <script>
        // --- L√≥gica del Login y Transici√≥n ---
        document.addEventListener('DOMContentLoaded', () => {
            const loginForm = document.getElementById('login-form');
            const loginOverlay = document.getElementById('login-overlay');
            const appWrapper = document.getElementById('appWrapper');
            const loginBox = document.getElementById('loginBox');
            
            // Actualizar copyright
            document.getElementById('copyright').innerHTML = `&copy; ${new Date().getFullYear()} Penagos Hermanos. Todos los derechos reservados.`;

            // Verificar si el usuario ya est√° logueado en la sesi√≥n
            if (sessionStorage.getItem('isLoggedIn') === 'true') {
                loginOverlay.classList.add('hidden');
                document.body.style.overflow = 'auto';
                appWrapper.classList.add('visible');
            }
            
            const storedObfuscatedPass = 'cGVuYWdvczEyMw=='; // btoa('penagos123')

            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const enteredObfuscatedPass = btoa(password);

                if (username.toUpperCase() === 'PENAGOS' && enteredObfuscatedPass === storedObfuscatedPass) {
                    sessionStorage.setItem('isLoggedIn', 'true'); // Guardar estado en sessionStorage
                    loginOverlay.classList.add('hidden');
                    document.body.style.overflow = 'auto';
                    appWrapper.classList.add('visible');
                } else {
                    loginBox.classList.add('error-shake');
                    setTimeout(() => {
                        loginBox.classList.remove('error-shake');
                    }, 500);
                }
            });
        });

        // --- L√≥gica de la Herramienta ---
        window.jsPDF = window.jspdf.jsPDF;
        let resultados = {};
        
        function siguientePaso(paso) {
            document.querySelectorAll('.step-card').forEach(card => card.classList.remove('active'));
            document.getElementById(`step${paso}`).classList.add('active');
            window.scrollTo(0, 0);
            
            if (paso === 3) {
                calcularPaso3();
            }

            const titulos = ["Req. T√©rmicos", "Balance Biomasa", "Aire Combusti√≥n", "√Årea de Transferencia", "Dise√±o Aletas", "Dise√±o y Material", "Reporte Final"];
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = (paso / 7) * 100 + '%';
            progressBar.textContent = `Paso ${paso} de 7: ${titulos[paso-1]}`;
        }

        function calcularPaso1() {
            const aireCFM = parseFloat(document.getElementById('aireCFM').value);
            const tempAmbiente = parseFloat(document.getElementById('tempAmbiente').value);
            const tempSalida = parseFloat(document.getElementById('tempSalida').value);
            const cpBiomasa = parseFloat(document.getElementById('biomassType').value);
            const humedadBiomasa = parseFloat(document.getElementById('humedadBiomasa').value);
            const eficienciaHorno = parseFloat(document.getElementById('eficienciaHorno').value);
            const horasTrabajo = parseFloat(document.getElementById('horasTrabajo').value);

            const m_aire = aireCFM * 0.00055;
            const cp_aire = 1.05;
            const deltaT = tempSalida - tempAmbiente;
            
            const Q_proceso = m_aire * cp_aire * deltaT;
            const Q_horno_requerido = Q_proceso / (eficienciaHorno / 100);
            const Q_horno_btu = Q_horno_requerido * 3412.14;
            
            const cpBiomasa_efectivo = cpBiomasa * (1 - humedadBiomasa / 100);
            const m_cisco_total = (Q_horno_requerido * horasTrabajo * 3600) / cpBiomasa_efectivo;
            const consumo_por_hora = m_cisco_total / horasTrabajo;
            const consumo_por_minuto = consumo_por_hora / 60;

            resultados.paso1 = { m_aire, deltaT, Q_proceso, Q_horno_requerido, Q_horno_btu, cpBiomasa_efectivo, m_cisco_total, consumo_por_hora, consumo_por_minuto, aireCFM, horasTrabajo, eficienciaHorno, humedadBiomasa, biomassType: {value: cpBiomasa, text: document.getElementById('biomassType').selectedOptions[0].text} };

            document.getElementById('resultados1').innerHTML = `
                <h4>üìä Resultados Termodin√°micos:</h4>
                <div class="result-highlight">
                    <strong>Potencia Requerida del Horno: ${Q_horno_requerido.toFixed(2)} kW / ${Q_horno_btu.toLocaleString('en-US', {maximumFractionDigits:0})} BTU/hr</strong><br>
                    <small>(Considerando ${eficienciaHorno}% de eficiencia para entregar ${Q_proceso.toFixed(2)} kW √∫tiles al proceso)</small><br><br>
                    <strong>Poder calor√≠fico efectivo (Biomasa al ${humedadBiomasa}% hum.):</strong> ${cpBiomasa_efectivo.toFixed(0)} kJ/kg<br>
                    <strong>Biomasa total necesaria para ${horasTrabajo}h:</strong> ${m_cisco_total.toFixed(1)} kg<br>
                    <strong>Consumo de biomasa por hora:</strong> ${consumo_por_hora.toFixed(2)} kg/h
                </div>`;
            document.getElementById('resultados1').style.display = 'block';
            document.getElementById('siguiente1').disabled = false;
        }

        function calcularPaso2() {
            const volumenMaquina = parseFloat(document.getElementById('volumenMaquina').value);
            const densidadCafe = parseFloat(document.getElementById('densidadCafe').value);
            const porcentajeCisco = parseFloat(document.getElementById('porcentajeCisco').value);
            
            const cafeCapacidad = volumenMaquina * densidadCafe;
            const cps_final = cafeCapacidad * 0.5;
            const cisco_generado = cps_final * (porcentajeCisco / 100);
            const cisco_total_req = resultados.paso1.m_cisco_total;
            const cisco_a_comprar = Math.max(0, cisco_total_req - cisco_generado);
            const porcentaje_cubierto = Math.min(100, (cisco_generado / cisco_total_req) * 100);
            const porcentaje_a_comprar = 100 - porcentaje_cubierto;

            resultados.paso2 = { cafeCapacidad, volumenMaquina, densidadCafe, cisco_generado, cisco_a_comprar, porcentaje_a_comprar, cisco_total_req };

            document.getElementById('resultados2').innerHTML = `
                <h4>‚òï Resultados del Balance de Biomasa:</h4>
                <div class="result-highlight">
                    <strong>Capacidad de la m√°quina:</strong> ${cafeCapacidad.toFixed(1)} kg de caf√© h√∫medo (${volumenMaquina} m¬≥ @ ${densidadCafe} kg/m¬≥)<br>
                    <strong>Cisco generado en el proceso de secado:</strong> ${cisco_generado.toFixed(1)} kg<br>
                    <strong>Biomasa total requerida por el horno:</strong> ${cisco_total_req.toFixed(1)} kg<br>
                    <strong>Porcentaje cubierto con cisco propio:</strong> ${porcentaje_cubierto.toFixed(1)}%<br>
                    <strong style="color:${cisco_a_comprar > 0 ? '#f87171' : '#4ade80'};">Biomasa que se necesita comprar: ${cisco_a_comprar.toFixed(1)} kg (${porcentaje_a_comprar > 0 ? porcentaje_a_comprar.toFixed(1) : '0'}%)</strong>
                </div>`;
            document.getElementById('resultados2').style.display = 'block';
            document.getElementById('siguiente2').disabled = false;
        }
        
        function calcularPaso3() {
            const aire_requerido_kgmin = resultados.paso1.consumo_por_minuto * 20;
            const aire_combustion_cfm = aire_requerido_kgmin * 32;
            resultados.paso3 = { aire_combustion_cfm };
            document.getElementById('resultados3').innerHTML = `
                <h4>üî• Resultados de Aire para Combusti√≥n:</h4>
                <div class="result-highlight">
                    <strong>Consumo de combustible:</strong> ${resultados.paso1.consumo_por_minuto.toFixed(3)} kg/min<br>
                    <strong>Aire requerido para combusti√≥n:</strong> ${aire_requerido_kgmin.toFixed(2)} kg/min
                </div>
                <div class="warning">
                    üí° Se recomienda un <strong>ventilador de combusti√≥n</strong> (secundario, no el de proceso) con una capacidad de al menos <strong>${aire_combustion_cfm.toFixed(1)} CFM</strong>.
                </div>`;
             document.getElementById('resultados3').style.display = 'block';
        }

        function calcularTransferencia() {
            const h = parseFloat(document.getElementById('coeficienteH').value);
            const emissividad = parseFloat(document.getElementById('emissividad').value);
            const tempSuperficie = parseFloat(document.getElementById('tempSuperficie').value);
            const areaComun = parseFloat(document.getElementById('areaComun').value);
            
            const deltaT = 45;
            const sigma = 5.67e-8;
            const tempSuperficieK = tempSuperficie + 273.15;
            const tempAireK = 312.5 + 273.15;

            const Q_conv = h * areaComun * deltaT;
            const Q_rad = areaComun * emissividad * sigma * (Math.pow(tempSuperficieK, 4) - Math.pow(tempAireK, 4));
            const Q_total = (Q_conv + Q_rad) / 1000;

            resultados.paso4 = { areaComun, Q_total, Q_horno_requerido: resultados.paso1.Q_horno_requerido, tempSuperficie };
            
            const diferencia = Math.abs(Q_total - resultados.paso4.Q_horno_requerido);
            const porcentajeError = (diferencia / resultados.paso4.Q_horno_requerido) * 100;
            
            document.getElementById('objetivoCalor').innerHTML = `üéØ <strong>OBJETIVO DE POTENCIA DEL HORNO:</strong> <span class="objetivo-highlight">${resultados.paso1.Q_horno_requerido.toFixed(2)} kW</span>`;
            document.getElementById('objetivoCalor').style.display = 'block';

            document.getElementById('resultados4').innerHTML = `
                <h4>üå°Ô∏è Transferencia de Calor Calculada:</h4>
                <div class="result-highlight">
                    <strong>Q total transferido con ${areaComun.toFixed(2)} m¬≤:</strong> ${Q_total.toFixed(2)} kW<br>
                    <strong>Diferencia vs. Objetivo:</strong> ${diferencia.toFixed(2)} kW (${porcentajeError.toFixed(1)}%)
                </div>
                <div class="warning">
                    ${porcentajeError > 5 ? `‚ö†Ô∏è AJUSTAR √ÅREA: La diferencia es > 5%.` : `‚úÖ VALIDADO: El √°rea de transferencia es adecuada.`}
                </div>`;
            document.getElementById('resultados4').style.display = 'block';
            if (porcentajeError <= 5) {
                document.getElementById('siguiente4').disabled = false;
            } else {
                 document.getElementById('siguiente4').disabled = true;
            }
        }

        function iterarArea() {
            const Q_requerido_W = resultados.paso1.Q_horno_requerido * 1000;
            const h = parseFloat(document.getElementById('coeficienteH').value);
            const emissividad = parseFloat(document.getElementById('emissividad').value);
            const tempSuperficie = parseFloat(document.getElementById('tempSuperficie').value);
            const deltaT = 45;
            const sigma = 5.67e-8;
            const tempSuperficieK = tempSuperficie + 273.15;
            const tempAireK = 312.5 + 273.15;
            let areaEstimada = Q_requerido_W / (h * deltaT + emissividad * sigma * (Math.pow(tempSuperficieK, 4) - Math.pow(tempAireK, 4)));
            document.getElementById('areaComun').value = areaEstimada.toFixed(2);
            calcularTransferencia();
        }

        function toggleAletas() {
            const usarAletas = document.getElementById('usarAletas').checked;
            document.getElementById('aletas-params-div').style.display = usarAletas ? 'block' : 'none';
            document.getElementById('disenoAletasDiv').style.display = usarAletas ? 'block' : 'none';
            if (!usarAletas) {
                resultados.paso5 = { usarAletas: false };
                document.getElementById('resultados5').style.display = 'none';
            }
        }
        
        function calcularDisenoAletas() {
            const K = parseFloat(document.getElementById('aletaK').value);
            const Ac_mm2 = parseFloat(document.getElementById('aletaAc').value);
            const h = parseFloat(document.getElementById('aletaH').value);
            const P_mm = parseFloat(document.getElementById('aletaP').value);
            const Ac_m2 = Ac_mm2 / 1000000;
            const P_m = P_mm / 1000;
            const L_min = 2.65 * Math.sqrt((K * Ac_m2) / (h * P_m));
            resultados.paso5 = { usarAletas: true, L_min };
            
            // Auto-llenar el campo en el paso 6
            document.getElementById('largoAletas').value = L_min.toFixed(2);
            
            document.getElementById('resultados5').innerHTML = `
                <h4>üìè Resultados de Aleta √ìptima:</h4>
                <div class="result-highlight">
                    <strong>Longitud m√≠nima recomendada de aleta:</strong> ${(L_min * 100).toFixed(1)} cm (${L_min.toFixed(2)} m)<br>
                    <small>Este valor ha sido transferido autom√°ticamente al campo 'Largo Aletas' en el Paso 6.</small>
                </div>`;
            document.getElementById('resultados5').style.display = 'block';
        }

        function calcularDisenoGeometrico() {
            if (!resultados.paso4 || typeof resultados.paso4.areaComun === 'undefined') {
                document.getElementById('resultados6').innerHTML = `<div class="warning"><h4>Error de Flujo de Trabajo</h4><p>Debe completar el <strong>Paso 4 (Transferencia de Calor)</strong> y obtener un √°rea requerida v√°lida antes de poder validar el dise√±o geom√©trico.</p></div>`;
                document.getElementById('resultados6').style.display = 'block';
                return; 
            }

            const radioPrincipal = parseFloat(document.getElementById('radioPrincipal').value);
            const alturaPrincipal = parseFloat(document.getElementById('alturaPrincipal').value);
            const radioCiclonico = parseFloat(document.getElementById('radioCiclonico').value);
            const alturaCiclonico = parseFloat(document.getElementById('alturaCiclonico').value);
            const usarAletas = document.getElementById('usarAletas').checked;
            const areaCilindroPrincipal = 2 * Math.PI * radioPrincipal * alturaPrincipal;
            const areaCilindroCiclonico = radioCiclonico > 0 ? 2 * Math.PI * radioCiclonico * alturaCiclonico : 0;
            let areaAletas = 0;
            let numAletas=0, largoAletas=0, anchoAletas=0, validacionAletas = true, mensajeAletasError = '';
            
            if (usarAletas) {
                if (!resultados.paso5 || typeof resultados.paso5.L_min === 'undefined') {
                    validacionAletas = false;
                    mensajeAletasError = 'Debe calcular primero la longitud m√≠nima en el Paso 5.';
                } else {
                    numAletas = parseFloat(document.getElementById('numAletas').value);
                    largoAletas = parseFloat(document.getElementById('largoAletas').value);
                    anchoAletas = parseFloat(document.getElementById('anchoAletas').value);
                    areaAletas = numAletas * largoAletas * anchoAletas * 2;
                    if (largoAletas < resultados.paso5.L_min) {
                        validacionAletas = false;
                        mensajeAletasError = `El largo de aletas (${(largoAletas*100).toFixed(1)} cm) es MENOR al m√≠nimo recomendado (${(resultados.paso5.L_min*100).toFixed(1)} cm).`;
                    }
                }
            }
            
            const areaTotal = areaCilindroPrincipal + areaCilindroCiclonico + areaAletas;
            const areaRequerida = resultados.paso4.areaComun;
            const validacionArea = areaTotal >= areaRequerida;

            // C√°lculo de material y costo
            const materialDensity = parseFloat(document.getElementById('materialType').value);
            const materialSelect = document.getElementById('materialType');
            const materialName = materialSelect.options[materialSelect.selectedIndex].text;
            const materialThickness_mm = parseFloat(document.getElementById('materialThickness').value);
            const materialThickness_m = materialThickness_mm / 1000;
            const materialPrice = parseFloat(document.getElementById('materialPrice').value);
            
            const materialVolume = areaTotal * materialThickness_m;
            const materialWeight = materialVolume * materialDensity;
            const materialCost = materialWeight * materialPrice;
            
            resultados.paso6 = { radioPrincipal, alturaPrincipal, radioCiclonico, alturaCiclonico, areaCilindroPrincipal, areaCilindroCiclonico, areaAletas, areaTotal, numAletas, largoAletas, anchoAletas, validacionArea, validacionAletas, materialName, materialThickness_mm, materialWeight, materialCost };
            
            let isDesignValid = validacionArea && validacionAletas;
            let validationMessageHTML = `
                <h4>üìê Resultados del Dise√±o Geom√©trico:</h4>
                <div class="result-highlight">
                    <strong>√ÅREA TOTAL DISE√ëADA: ${areaTotal.toFixed(2)} m¬≤</strong> (Requerida: ${areaRequerida.toFixed(2)} m¬≤)
                </div>
                 <h4>üî© Resultados de Material y Costo:</h4>
                 <div class="result-highlight">
                    <strong>Peso Aproximado (${materialThickness_mm} mm ${materialName.split('(')[0].trim()}): ${materialWeight.toFixed(1)} kg</strong><br>
                    <strong>Costo Estimado de Material: $${materialCost.toLocaleString('es-CO', {maximumFractionDigits:0})} COP</strong>
                 </div>
                <div class="warning">
                    <p><strong>Validaci√≥n de √Årea:</strong> ${validacionArea ? '‚úÖ CUMPLE' : `‚ùå INSUFICIENTE - Se requieren ${areaRequerida.toFixed(2)} m¬≤.`}</p>
                    ${usarAletas ? `<p><strong>Validaci√≥n de Aletas:</strong> ${validacionAletas ? '‚úÖ ADECUADAS' : `‚ùå INV√ÅLIDAS - ${mensajeAletasError}`}</p>` : ''}
                    <br>
                    ${isDesignValid ? 
                        '<p style="color:#4ade80; font-weight:bold;">¬°Dise√±o v√°lido! Ya puede generar el reporte final.</p>' : 
                        '<p style="color:#f87171; font-weight:bold;">El dise√±o no es v√°lido. Corrija los puntos marcados con ‚ùå para poder continuar.</p>'}
                </div>`;

            document.getElementById('resultados6').innerHTML = validationMessageHTML;
            document.getElementById('resultados6').style.display = 'block';
            document.getElementById('siguiente6').disabled = !isDesignValid;
        }

        function handleFinalize() {
            try {
                generarReporteFinal();
            } catch (error) {
                console.error("Error al generar el reporte final:", error);
                document.getElementById('reporteFinal').innerHTML = `<div class="warning"><h4>Ocurri√≥ un error al generar el reporte.</h4><p>Aseg√∫rese de haber completado todos los pasos en orden. Error: ${error.message}</p></div>`;
            }
            siguientePaso(7);
        }

        function generarReporteFinal() {
            const r = resultados;
            const heatFlux = r.paso1.Q_horno_requerido / r.paso6.areaTotal;
            const relacionAspecto = r.paso6.alturaPrincipal / (r.paso6.radioPrincipal * 2);
            const aporteAletas = r.paso6.areaAletas > 0 ? (r.paso6.areaAletas / r.paso6.areaTotal) * 100 : 0;

            let recomendacionesHTML = `
                <li>La relaci√≥n altura/di√°metro del horno es <strong>${relacionAspecto.toFixed(1)}</strong>. Valores entre 2 y 4 favorecen una buena circulaci√≥n de gases y una combusti√≥n m√°s estable.</li>
                <li>El flujo de calor es de <strong>${heatFlux.toFixed(2)} kW/m¬≤</strong>. Este valor es clave para seleccionar el espesor del acero y el tipo de aislamiento t√©rmico. Un flujo muy alto puede requerir materiales m√°s robustos.</li>
                ${aporteAletas > 0 ? `<li>Las aletas aportan un <strong>${aporteAletas.toFixed(1)}%</strong> del √°rea total de transferencia. Son un m√©todo efectivo para aumentar la transferencia sin alterar dr√°sticamente el cuerpo principal del horno.</li>` : ''}
                `;
            
            if (r.paso6.areaAletas <= 0) {
                 recomendacionesHTML += `<li><b>Considere a√±adir aletas:</b> Las aletas aumentan el √°rea de contacto con el aire sin agrandar el horno, mejorando significativamente la eficiencia t√©rmica.</li>`;
            }

            if (r.paso2.cisco_a_comprar > 0) {
                recomendacionesHTML += `<li>Dado que se debe adquirir un <strong>${r.paso2.porcentaje_a_comprar.toFixed(1)}%</strong> de la biomasa, es crucial asegurar proveedores locales con antelaci√≥n.</li>`;
            }

            document.getElementById('reporteFinal').innerHTML = `
                <div class="report-section">
                    <h3>FICHA T√âCNICA DE DISE√ëO: Horno de Biomasa (Penagos)</h3>
                    <table class="report-table">
                        <tr><td>Fecha de C√°lculo</td><td>${new Date().toLocaleDateString('es-CO')}</td></tr>
                        <tr><td>Tipo de Biomasa</td><td>${r.paso1.biomassType.text.split('(')[0].trim()}</td></tr>
                    </table>
                </div>

                <div class="report-section">
                    <h3>Especificaciones de Rendimiento T√©rmico</h3>
                    <table class="report-table">
                        <tr><td>Potencia del Horno</td><td><strong>${r.paso1.Q_horno_requerido.toFixed(2)} kW / ${r.paso1.Q_horno_btu.toLocaleString('en-US', {maximumFractionDigits:0})} BTU/hr</strong></td></tr>
                        <tr><td>Eficiencia de Dise√±o</td><td>${r.paso1.eficienciaHorno}%</td></tr>
                        <tr><td>Temperatura de Superficie</td><td>${r.paso4.tempSuperficie}¬∞C</td></tr>
                        <tr><td>Flujo de Calor (Heat Flux)</td><td>${heatFlux.toFixed(2)} kW/m¬≤</td></tr>
                    </table>
                </div>

                 <div class="report-section">
                    <h3>Par√°metros Clave de Operaci√≥n</h3>
                     <table class="report-table">
                        <tr><td>Potencia √ötil al Proceso</td><td>${r.paso1.Q_proceso.toFixed(2)} kW</td></tr>
                        <tr><td>Flujo M√°sico de Aire</td><td>${r.paso1.m_aire.toFixed(3)} kg/s</td></tr>
                        <tr><td>Incremento de Temperatura (ŒîT)</td><td>${r.paso1.deltaT.toFixed(1)} ¬∞C</td></tr>
                        <tr><td>Consumo de Biomasa</td><td>${r.paso1.consumo_por_hora.toFixed(2)} kg/h</td></tr>
                     </table>
                </div>

                <div class="report-section">
                    <h3>Par√°metros Constructivos y Geom√©tricos</h3>
                     <table class="report-table">
                        <tr><td>Cilindro Principal</td><td>√ò${(r.paso6.radioPrincipal * 2 * 100).toFixed(0)} cm √ó ${r.paso6.alturaPrincipal.toFixed(2)} m</td></tr>
                        <tr><td>√Årea Cilindro Principal</td><td>${r.paso6.areaCilindroPrincipal.toFixed(2)} m¬≤</td></tr>
                        <tr><td>Filtro Cicl√≥nico</td><td>${r.paso6.radioCiclonico > 0 ? `√ò${(r.paso6.radioCiclonico * 2 * 100).toFixed(0)} cm √ó ${r.paso6.alturaCiclonico.toFixed(2)} m` : 'No utilizado'}</td></tr>
                        <tr><td>√Årea Filtro Cicl√≥nico</td><td>${r.paso6.radioCiclonico > 0 ? `${r.paso6.areaCilindroCiclonico.toFixed(2)} m¬≤` : 'No aplica'}</td></tr>
                        <tr><td>Aletas</td><td>${(r.paso6.areaAletas > 0) ? `${r.paso6.numAletas} uds. (${r.paso6.areaAletas.toFixed(2)} m¬≤)` : 'No utilizadas'}</td></tr>
                        <tr><td>√Årea de Transferencia Total</td><td><strong>${r.paso6.areaTotal.toFixed(2)} m¬≤</strong></td></tr>
                        <tr><td>Ventilador de Proceso</td><td>${r.paso1.aireCFM} CFM</td></tr>
                        <tr><td>Ventilador de Combusti√≥n</td><td>${r.paso3.aire_combustion_cfm.toFixed(1)} CFM</td></tr>
                     </table>
                </div>

                <div class="report-section">
                    <h3>Materiales, Peso y Costo</h3>
                     <table class="report-table">
                        <tr><td>Material Estructural</td><td>${r.paso6.materialName.split('(')[0].trim()}</td></tr>
                        <tr><td>Espesor de L√°mina</td><td>${r.paso6.materialThickness_mm} mm</td></tr>
                        <tr><td>Peso Total Estimado</td><td><strong>${r.paso6.materialWeight.toFixed(1)} kg</strong></td></tr>
                        <tr><td>Costo Aprox. Material</td><td><strong>$${r.paso6.materialCost.toLocaleString('es-CO', {maximumFractionDigits:0})} COP</strong></td></tr>
                        <tr><td>Aislamiento T√©rmico Sugerido</td><td>Lana de Roca o Fibra Cer√°mica (2-4 pulgadas)</td></tr>
                        <tr><td>Seguridad Esencial</td><td>Chimenea de altura adecuada, control de tiro (damper), puerta con sello herm√©tico.</td></tr>
                     </table>
                </div>

                 <div class="report-section">
                    <h3>Recomendaciones de Dise√±o e Implementaci√≥n</h3>
                     <ul>${recomendacionesHTML}</ul>
                </div>
                <div class="report-footer">
                    Herramienta desarrollada por Jonathan Jerez, Ingeniero Mec√°nico.
                </div>`;
        }

        function descargarPDF() {
            const pdfButton = document.getElementById('pdfButton');
            const originalText = pdfButton.innerHTML;
            pdfButton.innerHTML = 'Generando PDF...';
            pdfButton.disabled = true;

            const reporte = document.getElementById('reporteFinal');
            const { jsPDF } = window.jspdf;

            html2canvas(reporte, { scale: 2, useCORS: true }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                
                const imgProps= pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth() - 20; // with margin
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                
                let heightLeft = pdfHeight;
                let position = 10; // top margin
                
                pdf.addImage(imgData, 'PNG', 10, position, pdfWidth, pdfHeight);
                heightLeft -= pdf.internal.pageSize.getHeight();

                while (heightLeft > -20) { // small tolerance
                  position = -pdf.internal.pageSize.getHeight() * (Math.abs(heightLeft / pdfHeight) -1) + 10;
                  pdf.addPage();
                  pdf.addImage(imgData, 'PNG', 10, position, pdfWidth, pdfHeight);
                  heightLeft -= pdf.internal.pageSize.getHeight();
                }
                
                pdf.save(`Ficha-Tecnica-Horno-${new Date().toISOString().slice(0,10)}.pdf`);
                pdfButton.innerHTML = originalText;
                pdfButton.disabled = false;

            }).catch(error => {
                console.error("Error al generar el PDF:", error);
                alert("Ocurri√≥ un error al generar el PDF. Aseg√∫rese de tener conexi√≥n a internet y vuelva a intentarlo.");
                pdfButton.innerHTML = originalText;
                pdfButton.disabled = false;
            });
        }
        
        function reiniciarCalculo() {
            sessionStorage.removeItem('isLoggedIn');
            location.reload();
        }
    </script>
</body>
</html>